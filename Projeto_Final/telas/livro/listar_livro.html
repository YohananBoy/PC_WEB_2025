<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Biblioteca CEFET-RJ</title>
    <link rel="stylesheet" href="../../css/estilo.css" />
  </head>
  <body>
    <div class="container">
      <h1>Biblioteca do CEFET-RJ Nova Friburgo</h1>

      <section class="acoes">
        <h2>Gerenciamento</h2>
        <input
          type="text"
          id="busca"
          placeholder="Buscar por título, autor ou gênero"
        />
        <button id="consultarLivros">Consultar</button>
        <button id="listarLivros">Listar Todos</button>
      </section>

      <section id="areaBusca">
        <h3>Resultado da Busca</h3>
        <div id="saidaBusca" class="resultado"></div>
      </section>
    </div>
    <script>
      //Código escrito por Yohanan
      const btnConsultarLivros = document.querySelector("#consultarLivros")
      const btnListarTodosLivros = document.querySelector("#listarLivros")
      const btnCadastrarLivro = document.querySelector("#cadastrarLivro")
      const btnRegistrarRetirada = document.querySelector("#registrarRetirada")
      const divSaida = document.querySelector("#saidaBusca")
      const divCadastro = document.querySelector("#saida")
      const inputBusca = document.querySelector("#busca")
      const inputRetirada = document.querySelector("#issnRetirada")
      const inputIssn = document.querySelector("#novoIssn")
      const inputTitulo = document.querySelector("#novoTitulo")
      const inputAutor = document.querySelector("#novoAutor")
      const inputEditora = document.querySelector("#novoEditora")
      const inputAno = document.querySelector("#novoAno")
      const inputGenero = document.querySelector("#novoGenero")
      const inputLocal = document.querySelector("#novoLocal")

      /**
       * Função que pega os livros do bando de dados
       */
      async function pegaLivros() {
        const url = "http://localhost/Projeto_Final_Back/index.php?modulo=livro"

        let resposta = await fetch(url)
        let dados = await resposta.json()

        return dados
      }

      /**
       * Função que filtra todos os itens de uma array
       * e compara o filtro com titulo, genero e autor
       */
      function filtraLivros(livros, filtro) {
        if (!filtro || filtro.trim() === "") {
          return
        }

        return livros.filter(
          (livro) =>
            livro.titulo.toLowerCase().startsWith(filtro.toLowerCase()) ||
            livro.genero.toLowerCase().startsWith(filtro.toLowerCase()) ||
            livro.autor.toLowerCase().startsWith(filtro.toLowerCase())
        )
      }
      /**
       * Função que exibe todos os itens de uma array
       * em uma lista
       */
      function exibeLivros(livros) {
        divSaida.innerHTML = ""
        let table = document.createElement("table")
        table.innerHTML =
          "<tr><th>ISSN</th> <th>Título</th> <th>Autor</th> <th>Ano de Publicação</th> <th>Genero</th> <th>Localização</th> <th>Disponibilidade</th> <th colspan='2'>Ações</th></tr>"
        table.border = 1
        livros.forEach((livro) => {
          let divLivro = document.createElement("div")
          divLivro.classList.add("livro")
          let titulo = document.createElement("h3")
          titulo.textContent = livro.titulo
          divLivro.appendChild(titulo)
          let btnDetalhes = document.createElement("button")
          btnDetalhes.textContent = "Mostrar Detalhes"
          btnDetalhes.addEventListener("click", () => {
            mostrarDetalhes(livro, divLivro)
          })
          titulo.classList.add("livro-titulo")
          btnDetalhes.classList.add("livro-botao")
          divLivro.appendChild(btnDetalhes)
          divSaida.appendChild(divLivro)
        })
      }

      /**
       * Função que exibe todos os atributos de um livro
       * caso o usuário clique no botão "Mostar Detalhes"
       */
      function mostrarDetalhes(livro, divLivro) {
        let detalhesExistem = divLivro.querySelector(".detalhes")
        if (detalhesExistem) {
          detalhesExistem.remove()
          return
        }

        let divDetalhes = document.createElement("div")
        divDetalhes.classList.add("detalhes")
        divDetalhes.classList.add("livro-detalhes")

        divDetalhes.innerHTML = `
    <p><strong>ISSN:</strong> ${livro.ISSN}</p>
    <p><strong>Autor:</strong> ${livro.autor}</p>
    <p><strong>Ano:</strong> ${livro.anoPublicacao}</p>
    <p><strong>Gênero:</strong> ${livro.genero}</p>
    <p><strong>Localização:</strong> ${livro.localizacao}</p>
    <p><strong>Disponibilidade:</strong> ${
      Number(livro.disponivel) ? "Disponível" : "Não disponível"
    }</p>
  `

        divLivro.appendChild(divDetalhes)
      }

      /**
       * Função que deverá pegar o parâmetro de filtro e listar todos os
       * exemplares que satisfizerem a condição
       */
      async function consultarLivros() {
        let dados = await pegaLivros()
        let livros = filtraLivros(dados, inputBusca.value)
        exibeLivros(livros)
      }

      /**
       * Função que deverá listar na tela todos os livros do acervo
       */
      async function listarTodos() {
        let livros = await pegaLivros()
        exibeLivros(livros)
      }

      /*
       * Bloco de chamada de eventos
       */
      btnConsultarLivros.addEventListener("click", consultarLivros)
      btnListarTodosLivros.addEventListener("click", listarTodos)
    </script>
  </body>
</html>
