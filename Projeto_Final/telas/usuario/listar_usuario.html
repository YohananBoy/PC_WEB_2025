<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Biblioteca CEFET-RJ</title>
    <link rel="stylesheet" href="../../css/estilo.css" />
  </head>
  <body>
    <div class="container">
      <h1>Biblioteca do CEFET-RJ Nova Friburgo</h1>

      <section class="acoes">
        <h2>Gerenciamento</h2>
        <input type="text" id="busca" placeholder="Buscar por nome" />
        <button id="consultarUsuarios">Consultar</button>
        <button id="listarUsuarios">Listar Todos</button>
      </section>

      <section id="areaBusca">
        <h3>Resultado da Busca</h3>
        <div id="saidaBusca" class="resultado"></div>
      </section>
    </div>
    <script>
      //Código escrito por Yohanan
      const btnConsultarUsuarios = document.querySelector("#consultarUsuarios")
      const btnListarTodosUsuarios = document.querySelector("#listarUsuarios")
      const divSaida = document.querySelector("#saidaBusca")
      const inputBusca = document.querySelector("#busca")

      /**
       * Função que pega os usuarios do bando de dados
       */
      async function pegaUsuarios() {
        const url =
          "http://localhost/Projeto_Final_Back/index.php?modulo=usuario"

        let resposta = await fetch(url)
        let dados = await resposta.json()

        return dados
      }

      /**
       * Função que filtra todos os itens de uma array
       * e compara o filtro com email, genero e senha
       */
      function filtraUsuarios(usuarios, filtro) {
        if (!filtro || filtro.trim() === "") {
          return
        }

        return usuarios.filter((usuario) =>
          usuario.nome.toLowerCase().startsWith(filtro.toLowerCase())
        )
      }
      /**
       * Função que exibe todos os itens de uma array
       * em uma lista
       */
      function exibeUsuarios(usuarios) {
        divSaida.innerHTML = ""

        usuarios.forEach((usuario) => {
          let divUsuario = document.createElement("div")
          divUsuario.classList.add("usuario")

          let nome = document.createElement("h3")
          nome.textContent = usuario.nome
          nome.classList.add("usuario-titulo")

          let btnDetalhes = document.createElement("button")
          btnDetalhes.textContent = "Mostrar Detalhes"
          btnDetalhes.classList.add("usuario-botao")

          btnDetalhes.addEventListener("click", () => {
            mostrarDetalhes(usuario, divUsuario)
          })

          divUsuario.appendChild(nome)
          divUsuario.appendChild(btnDetalhes)
          divSaida.appendChild(divUsuario)
        })
      }

      /**
       * Função que exibe todos os atributos de um usuario
       * caso o usuário clique no botão "Mostar Detalhes"
       */
      function mostrarDetalhes(usuario, divUsuario) {
        let detalhesExistem = divUsuario.querySelector(".usuario-detalhes")
        if (detalhesExistem) {
          detalhesExistem.remove()
          return
        }

        let divDetalhes = document.createElement("div")
        divDetalhes.classList.add("detalhes", "usuario-detalhes")

        divDetalhes.innerHTML = `
    <p><strong>Nome:</strong> ${usuario.nome}</p>
    <p><strong>Email:</strong> ${usuario.email}</p>
    <p><strong>Senha:</strong> ${usuario.senha}</p>
    <p>
      <a href="cadastrar_usuario.html?id=${usuario.id}">Atualizar</a> |
      <a href="remover_usuario.html?id=${usuario.id}">Remover</a>
    </p>
  `

        divUsuario.appendChild(divDetalhes)
      }

      /**
       * Função que deverá pegar o parâmetro de filtro e listar todos os
       * exemplares que satisfizerem a condição
       */
      async function consultarUsuarios() {
        let dados = await pegaUsuarios()
        let usuarios = filtraUsuarios(dados, inputBusca.value)
        exibeUsuarios(usuarios)
      }

      /**
       * Função que deverá listar na tela todos os usuarios do acervo
       */
      async function listarTodos() {
        let usuarios = await pegaUsuarios()
        exibeUsuarios(usuarios)
      }

      /*
       * Bloco de chamada de eventos
       */
      btnConsultarUsuarios.addEventListener("click", consultarUsuarios)
      btnListarTodosUsuarios.addEventListener("click", listarTodos)
    </script>
  </body>
</html>
